<Window x:Class="WinfxkVoiceHub.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Winfxk Voice Hub - 智能有声书阅读器" Height="880" Width="1150" 
        Background="#F0F2F5" WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- 1. 通用按钮基础样式 -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#DCDFE6"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECF5FF"/>
                    <Setter Property="BorderBrush" Value="#C6E2FF"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- 2. 现代 ComboBox 样式修复版：确保选中文字始终清晰可见 -->
        <Style TargetType="ComboBox">
            <Setter Property="Height" Value="35"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#DCDFE6"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid x:Name="MainGrid" SnapsToDevicePixels="true">
                            <ToggleButton x:Name="ToggleButton" 
                                          BorderBrush="{TemplateBinding BorderBrush}" 
                                          Background="{TemplateBinding Background}" 
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press" Grid.ColumnSpan="2">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border x:Name="templateRoot" CornerRadius="4" Background="{TemplateBinding Background}" BorderThickness="1" BorderBrush="{TemplateBinding BorderBrush}" SnapsToDevicePixels="true">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="30"/>
                                                </Grid.ColumnDefinitions>
                                                <Path x:Name="Arrow" Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Fill="#C0C4CC" Data="M0,0 L4,4 L8,0 Z"/>
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <!-- 修复的核心：ContentPresenter 必须在 ToggleButton 之上并绑定 SelectionBoxItem -->
                            <ContentPresenter x:Name="contentPresenter" Content="{TemplateBinding SelectionBoxItem}"
                                              ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                              ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                              Margin="10,0,30,0" VerticalAlignment="Center" HorizontalAlignment="Left"
                                              IsHitTestVisible="false" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>

                            <Popup x:Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                                <Grid x:Name="DropDown" SnapsToDevicePixels="True" MinWidth="{TemplateBinding ActualWidth}" MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                    <Border x:Name="DropDownBorder" Background="White" BorderThickness="1" BorderBrush="#DCDFE6" CornerRadius="4" Margin="0,2,0,5">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1" Color="Black"/>
                                        </Border.Effect>
                                        <ScrollViewer Margin="0,2" SnapsToDevicePixels="True">
                                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Padding" Value="10,8"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F7FA"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#ECF5FF"/>
                    <Setter Property="Foreground" Value="#409EFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- 1. 顶部配置面板 -->
            <RowDefinition Height="Auto"/>
            <!-- 2. 进度条区域 -->
            <RowDefinition Height="*"/>
            <!-- 3. 中部交互区 -->
            <RowDefinition Height="180"/>
            <!-- 4. 日志区 -->
        </Grid.RowDefinitions>

        <!-- 1. 核心配置面板 (利用右侧空间展示书籍信息) -->
        <Border Grid.Row="0" Background="White" CornerRadius="8" Padding="20" Margin="0,0,0,10">
            <Border.Effect>
                <DropShadowEffect BlurRadius="10" Color="#000000" Opacity="0.05" ShadowDepth="2"/>
            </Border.Effect>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="1.2*"/>
                </Grid.ColumnDefinitions>

                <!-- 左侧：音频配置 -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="音频链路设置" FontWeight="Bold" Foreground="#2C3E50" Margin="0,0,0,12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10" Height="25">
                        <RadioButton x:Name="RadioMic" Content="麦克风" IsChecked="True" Margin="0,0,20,0" VerticalAlignment="Center"/>
                        <RadioButton x:Name="RadioSystem" Content="系统声卡" VerticalAlignment="Center"/>
                    </StackPanel>
                    <ComboBox x:Name="InputDeviceCombo" Margin="0,0,0,10" SelectionChanged="OnSettingChanged"/>
                    <ComboBox x:Name="OutputDeviceCombo" SelectionChanged="OnSettingChanged"/>
                </StackPanel>

                <Separator Grid.Column="1" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="30,5" Width="1"/>

                <!-- 右侧：语速调节 + 书籍元数据 (空间利用率最大化) -->
                <StackPanel Grid.Column="2">
                    <Grid Margin="0,0,0,10">
                        <TextBlock Text="语音引擎与书籍元数据" FontWeight="Bold" Foreground="#2C3E50" VerticalAlignment="Center"/>
                        <Button HorizontalAlignment="Right" x:Name="BtnClear" Content="🗑️ 重置环境" Click="BtnClear_Click" 
                                Background="#FEF0F0" Foreground="#F56C6C" BorderBrush="#FBC4C4" Padding="12,4" FontSize="11"/>
                    </Grid>

                    <DockPanel LastChildFill="True" Margin="0,0,0,12">
                        <TextBlock Text="朗读语速" VerticalAlignment="Center" Margin="0,0,15,0" Foreground="#606266"/>
                        <TextBlock Text="{Binding ElementName=SliderSpeed, Path=Value, StringFormat={}{0:0}}" DockPanel.Dock="Right" Foreground="#409EFF" Width="30" TextAlignment="Right" FontWeight="Bold" FontSize="14"/>
                        <Slider x:Name="SliderSpeed" Minimum="-10" Maximum="10" Value="0" TickFrequency="1" IsSnapToTickEnabled="True" VerticalAlignment="Center" ValueChanged="OnSettingChanged"/>
                    </DockPanel>

                    <!-- 书籍信息移至此处，不再挤占下方空间 -->
                    <Border Background="#F5F7FA" CornerRadius="6" Padding="12,8">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📚" FontSize="14" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBlock x:Name="TxtFileInfo" Text="等待载入书籍指纹..." FontSize="12" Foreground="#606266" TextWrapping="Wrap" VerticalAlignment="Center" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 2. 进度条 -->
        <Border Grid.Row="1" Background="White" CornerRadius="8" Padding="15" Margin="0,0,0,10">
            <StackPanel>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock x:Name="TxtProgressLabel" Text="当前进度: 0/0" VerticalAlignment="Center" Foreground="#909399" FontSize="12" Width="160"/>
                    <TextBlock x:Name="TxtNowReading" Grid.Column="1" Text="等待朗读任务开始..." HorizontalAlignment="Center" FontWeight="SemiBold" Foreground="#67C23A" FontSize="14" TextTrimming="CharacterEllipsis" Margin="15,0"/>
                    <Button Grid.Column="2" Content="📑 浏览目录" Click="BtnOpenChapterSelector_Click" 
                            Padding="15,6" FontSize="12" BorderBrush="#409EFF" Foreground="#409EFF" Background="#ECF5FF"/>
                </Grid>
                <Slider x:Name="SliderProgress" Minimum="0" Maximum="100" Value="0" IsMoveToPointEnabled="True"
                        PreviewMouseLeftButtonUp="SliderProgress_PreviewMouseLeftButtonUp" Height="22"/>
            </StackPanel>
        </Border>

        <!-- 3. 中部交互区 -->
        <Grid Grid.Row="2" Margin="0,0,0,15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="280"/>
            </Grid.ColumnDefinitions>

            <Border Background="White" CornerRadius="8" Padding="15">
                <Grid>
                    <TextBox x:Name="TextInputField" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" 
                             TextWrapping="Wrap" Padding="10" FontSize="15" BorderThickness="1" 
                             BorderBrush="#EBEEF5" FontFamily="Microsoft YaHei"
                             SelectionBrush="#409EFF" SelectionOpacity="0.3"/>
                    <TextBlock x:Name="TxtWatermark" Text="键入文本或点击右侧导入..." IsHitTestVisible="False" 
                               Foreground="#C0C4CC" Margin="15,15,0,0" FontSize="15">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Text, ElementName=TextInputField}" Value="">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Border>

            <!-- 侧边栏操作区：专注于三大核心按钮 -->
            <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="20" Margin="15,0,0,0">
                <StackPanel>
                    <TextBlock Text="控制面板" FontWeight="Bold" Margin="0,0,0,20" FontSize="14" Foreground="#2C3E50"/>

                    <Button x:Name="BtnImportTxt" Content="📚 导入书籍" Height="50" Margin="0,0,0,15" Click="BtnImportTxt_Click" Background="#E6A23C" Foreground="White" BorderThickness="0" FontSize="14"/>

                    <Separator Background="#EBEEF5" Margin="5,5,5,20"/>

                    <Button x:Name="BtnStartRead" Content="▶ 开始播放" Height="55" Margin="0,0,0,15" Click="BtnStartRead_Click" Background="#67C23A" Foreground="White" BorderThickness="0" FontSize="16" FontWeight="Bold"/>

                    <Button x:Name="BtnListen" Content="🎙️ 实时对话" Height="55" Margin="0,0,0,15" Click="BtnToggleListen_Click" Background="#409EFF" Foreground="White" BorderThickness="0" FontSize="14"/>

                    <TextBlock Text="✨ 状态实时同步至星系" FontSize="11" Foreground="#C0C4CC" TextAlignment="Center" Margin="0,20,0,0" FontStyle="Italic"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- 4. 底部日志区 -->
        <Grid Grid.Row="3">
            <Border Background="#2B2D30" CornerRadius="8" Padding="5">
                <TextBox x:Name="LogConsole" IsReadOnly="True" Background="Transparent" Foreground="#6A9955" FontFamily="Consolas" FontSize="12" VerticalScrollBarVisibility="Auto" BorderThickness="0" Padding="10"/>
            </Border>
            <Button x:Name="BtnAbout" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,25,25" 
                    Background="Transparent" BorderThickness="0" Click="BtnAbout_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="🌌" FontSize="18" Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <TextBlock Text="冰月星系" Foreground="#409EFF" FontSize="13" VerticalAlignment="Center" FontWeight="SemiBold">
                        <TextBlock.Effect>
                            <DropShadowEffect BlurRadius="8" Color="#409EFF" Opacity="0.6"/>
                        </TextBlock.Effect>
                    </TextBlock>
                </StackPanel>
            </Button>
        </Grid>

        <!-- 加载与目录浮层 (保持逻辑不变) -->
        <Grid x:Name="LoadingOverlay" Grid.RowSpan="4" Background="#CCFFFFFF" Visibility="Collapsed">
            <Border Background="White" CornerRadius="12" Width="380" Height="200" VerticalAlignment="Center" HorizontalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" Color="Black" Opacity="0.15"/>
                </Border.Effect>
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <ProgressBar x:Name="ParseProgressBar" Width="280" Height="12" Foreground="#409EFF" Background="#EBEEF5" BorderThickness="0" Margin="0,0,0,25"/>
                    <TextBlock x:Name="TxtParseStatus" Text="同步冰月星系数据..." HorizontalAlignment="Center" Foreground="#303133" FontSize="15" FontWeight="Bold"/>
                    <TextBlock x:Name="TxtParseProgress" Text="请稍候..." HorizontalAlignment="Center" Foreground="#909399" FontSize="12" Margin="0,12,0,0"/>
                </StackPanel>
            </Border>
        </Grid>

        <Grid x:Name="ChapterOverlay" Grid.RowSpan="4" Background="#88000000" Visibility="Collapsed">
            <Border Background="White" CornerRadius="15" Width="600" MaxHeight="700" Margin="40" VerticalAlignment="Center">
                <Grid Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="📚 书籍目录索引" FontSize="22" FontWeight="Bold" Margin="0,0,0,20" Foreground="#2C3E50"/>
                    <TextBox x:Name="TxtChapterSearch" Grid.Row="1" Height="40" Margin="0,0,0,20" VerticalContentAlignment="Center" Padding="15,0" Tag="搜索章节..." TextChanged="TxtChapterSearch_TextChanged"/>
                    <ListBox x:Name="ChapterListBox" Grid.Row="2" BorderThickness="0" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling" SelectionChanged="ChapterListBox_SelectionChanged">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderThickness="0,0,0,1" BorderBrush="#F2F6FC" Padding="15,12">
                                    <TextBlock Text="{Binding FullTitle}" FontSize="15" Foreground="#303133"/>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <Button Grid.Row="3" Content="返回阅读" Click="BtnCloseChapter_Click" Margin="0,25,0,0" Background="#909399" Foreground="White" BorderThickness="0" Height="45" FontSize="14"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>