<Window x:Class="WinfxkVoiceHub.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Winfxk Voice Hub" Height="880" Width="1150" 
        Background="#F0F2F5" WindowStartupLocation="CenterScreen"
        KeyDown="Window_KeyDown" Closing="Window_Closing" StateChanged="Window_StateChanged">

    <Window.Resources>
        <Style TargetType="Button">
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#DCDFE6"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECF5FF"/>
                    <Setter Property="BorderBrush" Value="#C6E2FF"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- 2. 现代 ComboBox 样式 -->
        <Style TargetType="ComboBox">
            <Setter Property="Height" Value="35"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#DCDFE6"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid x:Name="MainGrid" SnapsToDevicePixels="true">
                            <ToggleButton x:Name="ToggleButton" 
                                          BorderBrush="{TemplateBinding BorderBrush}" 
                                          Background="{TemplateBinding Background}" 
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press" Grid.ColumnSpan="2">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border x:Name="templateRoot" CornerRadius="4" Background="{TemplateBinding Background}" BorderThickness="1" BorderBrush="{TemplateBinding BorderBrush}" SnapsToDevicePixels="true">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="30"/>
                                                </Grid.ColumnDefinitions>
                                                <Path x:Name="Arrow" Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Fill="#C0C4CC" Data="M0,0 L4,4 L8,0 Z"/>
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter x:Name="contentPresenter" Content="{TemplateBinding SelectionBoxItem}"
                                              ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                              ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                              Margin="10,0,30,0" VerticalAlignment="Center" HorizontalAlignment="Left"
                                              IsHitTestVisible="false" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            <Popup x:Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                                <Grid x:Name="DropDown" SnapsToDevicePixels="True" MinWidth="{TemplateBinding ActualWidth}" MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                    <Border x:Name="DropDownBorder" Background="White" BorderThickness="1" BorderBrush="#DCDFE6" CornerRadius="4" Margin="0,2,0,5">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1" Color="Black"/>
                                        </Border.Effect>
                                        <ScrollViewer Margin="0,2" SnapsToDevicePixels="True">
                                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Padding" Value="10,8"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F7FA"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#ECF5FF"/>
                    <Setter Property="Foreground" Value="#409EFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <!-- 全局生命悦动层：动态正弦频谱背景 -->
        <Canvas x:Name="VisualizerCanvas" IsHitTestVisible="False" Opacity="0.25">
            <Path x:Name="WavePath1" Stroke="#409EFF" StrokeThickness="3" VerticalAlignment="Center"/>
            <Path x:Name="WavePath2" Stroke="#67C23A" StrokeThickness="2" VerticalAlignment="Center" Opacity="0.6"/>
            <Path x:Name="WavePath3" Stroke="#E6A23C" StrokeThickness="1.5" VerticalAlignment="Center" Opacity="0.4"/>
        </Canvas>

        <Grid Margin="15">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="180"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="#CCFFFFFF" CornerRadius="8" Padding="20" Margin="0,0,0,10">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" Color="#000000" Opacity="0.05" ShadowDepth="2"/>
                </Border.Effect>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="1.2*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="音频链路设置" FontWeight="Bold" Foreground="#2C3E50" Margin="0,0,0,10"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8" Height="22">
                            <RadioButton x:Name="RadioMic" Content="麦克风" IsChecked="True" Margin="0,0,15,0" VerticalAlignment="Center"/>
                            <RadioButton x:Name="RadioSystem" Content="声卡回放" VerticalAlignment="Center"/>
                        </StackPanel>
                        <ComboBox x:Name="InputDeviceCombo" Margin="0,0,0,8" SelectionChanged="OnSettingChanged" ToolTip="录音输入"/>
                        <ComboBox x:Name="OutputDeviceCombo" SelectionChanged="OnSettingChanged" ToolTip="播放输出"/>
                    </StackPanel>

                    <Separator Grid.Column="1" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="20,5" Width="1"/>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="语音引擎选择" FontWeight="Bold" Foreground="#2C3E50" Margin="0,0,0,10"/>
                        <ComboBox x:Name="VoiceCombo" Margin="0,0,0,12" SelectionChanged="OnSettingChanged" ToolTip="选择发音角色"/>
                        <DockPanel LastChildFill="True">
                            <TextBlock Text="朗读语速" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="#606266"/>
                            <TextBlock Text="{Binding ElementName=SliderSpeed, Path=Value, StringFormat={}{0:0}}" DockPanel.Dock="Right" Foreground="#409EFF" Width="25" FontWeight="Bold" TextAlignment="Right"/>
                            <Slider x:Name="SliderSpeed" Minimum="-10" Maximum="10" Value="0" TickFrequency="1" IsSnapToTickEnabled="True" VerticalAlignment="Center" ValueChanged="OnSettingChanged"/>
                        </DockPanel>
                    </StackPanel>

                    <Separator Grid.Column="3" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="20,5" Width="1"/>

                    <StackPanel Grid.Column="4">
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="元数据" FontWeight="Bold" Foreground="#2C3E50" VerticalAlignment="Center"/>
                            <Button HorizontalAlignment="Right" x:Name="BtnClear" Content="🗑️ 重置环境" Click="BtnClear_Click" 
                                    Background="#FEF0F0" Foreground="#F56C6C" BorderBrush="#FBC4C4" Padding="12,4" FontSize="11"/>
                        </Grid>
                        <Border Background="#F5F7FA" CornerRadius="6" Padding="12,8" Height="60">
                            <TextBlock x:Name="TxtFileInfo" Text="等待书籍挂载..." FontSize="12" Foreground="#606266" TextWrapping="Wrap" VerticalAlignment="Center" FontWeight="SemiBold"/>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Row="1" Background="#CCFFFFFF" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                <StackPanel>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="TxtProgressLabel" Text="进度: 0/0" VerticalAlignment="Center" Foreground="#909399" FontSize="12" Width="140"/>
                        <TextBlock x:Name="TxtNowReading" Grid.Column="1" Text="等待任务开始..." HorizontalAlignment="Center" FontWeight="SemiBold" Foreground="#409EFF" FontSize="14" TextTrimming="CharacterEllipsis" Margin="15,0"/>
                        <Button Grid.Column="2" Content="📑 浏览目录" Click="BtnOpenChapterSelector_Click" 
                                Padding="15,6" FontSize="12" BorderBrush="#409EFF" Foreground="#409EFF" Background="#ECF5FF"/>
                    </Grid>
                    <Slider x:Name="SliderProgress" Minimum="0" Maximum="100" Value="0" IsMoveToPointEnabled="True"
                            PreviewMouseLeftButtonUp="SliderProgress_PreviewMouseLeftButtonUp" Height="22"/>
                </StackPanel>
            </Border>

            <Grid Grid.Row="2" Margin="0,0,0,15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="280"/>
                </Grid.ColumnDefinitions>

                <Border Background="White" CornerRadius="8" Padding="15" Opacity="0.9">
                    <TextBox x:Name="TextInputField" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" 
                             TextWrapping="Wrap" Padding="10" FontSize="16" BorderThickness="0" 
                             Background="Transparent" FontFamily="Microsoft YaHei"
                             SelectionBrush="#409EFF" SelectionOpacity="0.3"/>
                </Border>

                <Border Grid.Column="1" Background="#CCFFFFFF" CornerRadius="8" Padding="20" Margin="15,0,0,0">
                    <StackPanel VerticalAlignment="Center">
                        <Button x:Name="BtnImportTxt" Content="📚 导入书籍" Height="50" Margin="0,0,0,15" Click="BtnImportTxt_Click" Background="#E6A23C" Foreground="White" BorderThickness="0" FontSize="14"/>
                        <Separator Background="#EBEEF5" Margin="5,5,5,20"/>
                        <Button x:Name="BtnStartRead" Content="▶ 开始播放" Height="60" Margin="0,0,0,15" Click="BtnStartRead_Click" Background="#67C23A" Foreground="White" BorderThickness="0" FontSize="16" FontWeight="Bold">
                            <Button.Effect>
                                <DropShadowEffect BlurRadius="10" Color="#67C23A" Opacity="0.2"/>
                            </Button.Effect>
                        </Button>
                        <Button x:Name="BtnListen" Content="🎙️ 实时识别" Height="50" Margin="0,0,0,15" Click="BtnToggleListen_Click" Background="#409EFF" Foreground="White" BorderThickness="0" FontSize="14"/>
                        <TextBlock Text="作者：Winfxk（冰月）" FontSize="10" Foreground="#C0C4CC" TextAlignment="Center" Margin="0,15,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>

            <Grid Grid.Row="3">
                <Border Background="#2B2D30" CornerRadius="8" Padding="5" Opacity="0.9">
                    <TextBox x:Name="LogConsole" IsReadOnly="True" Background="Transparent" Foreground="#6A9955" FontFamily="Consolas" FontSize="12" VerticalScrollBarVisibility="Auto" BorderThickness="0" Padding="10"/>
                </Border>
                <Button x:Name="BtnAbout" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,25,25" 
                        Background="Transparent" BorderThickness="0" Click="BtnAbout_Click">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🌌" FontSize="18" Margin="0,0,8,0" VerticalAlignment="Center"/>
                        <TextBlock Text="冰月" Foreground="#409EFF" FontSize="13" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Grid>

        <Grid x:Name="LoadingOverlay" Background="#CCFFFFFF" Visibility="Collapsed">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Width="300" Height="10" IsIndeterminate="True" Foreground="#409EFF"/>
                <TextBlock x:Name="TxtParseStatus" Text="同步索引..." HorizontalAlignment="Center" FontSize="16" Margin="0,15"/>
            </StackPanel>
        </Grid>

        <Grid x:Name="ChapterOverlay" Background="#88000000" Visibility="Collapsed">
            <Border Background="White" CornerRadius="15" Width="650" MaxHeight="750" Margin="40" VerticalAlignment="Center">
                <Grid Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="📚 章节目录" FontSize="22" FontWeight="Bold" Margin="0,0,0,20" Foreground="#2C3E50"/>
                    <TextBox x:Name="TxtChapterSearch" Grid.Row="1" Height="42" Margin="0,0,0,20" VerticalContentAlignment="Center" Padding="15,0" Tag="搜索章节..." TextChanged="TxtChapterSearch_TextChanged"/>
                    <ListBox x:Name="ChapterListBox" Grid.Row="2" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled" SelectionChanged="ChapterListBox_SelectionChanged">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderThickness="0,0,0,1" BorderBrush="#F2F6FC" Padding="18,14">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding FullTitle}" FontSize="15" Foreground="#303133" TextWrapping="Wrap"/>
                                        <TextBlock Grid.Column="1" Text="📖" FontSize="14" VerticalAlignment="Center" Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <Button Grid.Row="3" Content="返回" Click="BtnCloseChapter_Click" Margin="0,25,0,0" Background="#909399" Foreground="White" BorderThickness="0" Height="48" FontSize="15"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>